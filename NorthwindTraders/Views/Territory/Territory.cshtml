
@model IEnumerable<NorthwindTraders.Models.Territory>
@{
    ViewBag.Title = "Territory";
}
<head>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<main>
    <div class="d-flex align-items-center mb-3">
        <h1 class="display-4 mb-0 me-3" style="line-height: 1;">Territory</h1>
        <button type="button" class="btn btn-success btn-lg" onclick="addOreditTerritory(0)">Add Territory</button>
    </div>



    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th>Territory ID</th>
                <th>Description</th>
                <th>Region ID</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model)
            {
                <tr>
                    <td>@item.TerritoryID</td>
                    <td>@item.TerritoryDescription</td>
                    <td>@item.RegionID</td>
                    <td><button type="button" class="btn btn-primary" onclick="addOreditTerritory('@item.TerritoryID')">Edit</button></td>
                    <td><button type="button" class="btn btn-danger" onclick="DeleteTerritory('@item.TerritoryID')">Delete</button></td>

                </tr>
            }
        </tbody>
    </table>
</main>
<script>
    function DeleteTerritory(id) {
        $.ajax({
            url: `/Territory/Delete?id=${id}`,
            type: 'POST', 
            contentType: 'application/json',
            success: function (data, textStatus, jqXHR) {
                // 200 OK
                Swal.fire('Deleted!', 'The Territory was deleted.', 'success');
            },
            error: function (jqXHR) {
                // jqXHR.status will be 409 or 404
                if (jqXHR.status === 409) {
                    // Conflict — parse JSON and show linked records
                    var data = JSON.parse(jqXHR.responseText);
                    var list = data.linkedEmployees
                        .map(function (e) { return '<li>' + e.FullName + '</li>'; })
                        .join('');
                    Swal.fire({
                        icon: 'error',
                        title: "Can Not Delete This Territory is Linked to the Employees below:",
                        html: '<p>' + list + '</p>'
                    });
                }
                else if (jqXHR.status === 404) {
                    var data = JSON.parse(jqXHR.responseText);
                    Swal.fire('Error', data.error, 'error');
                }
                else {
                    Swal.fire('Error', 'Unexpected error occurred', 'error');
                }
            }
        });
    }
    function addOreditTerritory(id) {
        $.ajax({
            url: `/Territory/AddOREditPopup?id=${id}`, // This returns your partial view HTML
            type: 'GET',
            success: function (partialViewHtml) {
                Swal.fire({
                    title: (id == 0) ? 'Add Territory' : 'Edit Territory',
                    html: partialViewHtml, // Render the partial view inside Swal
                    showCancelButton: true,
                    focusConfirm: false,
                    preConfirm: () => {
                        // Collect data from the partial view fields
                        let territoryId = $('#TerritoryID').val();
                        let description = $('#TerritoryDescription').val();
                        let regionId = $('#RegionID').val();

                        return {
                            TerritoryID: territoryId,
                            TerritoryDescription: description,
                            RegionID: regionId
                        };
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Send data to API
                        $.ajax({
                            url: '/Territory/AddOREdit',
                            type: 'POST',
                            contentType: 'application/json',
                            data: JSON.stringify(result.value),
                            success: function (res) {
                                Swal.fire('Success!', 'Data saved successfully', 'success');
                                // Optionally reload table/grid
                            },
                            error: function () {
                                Swal.fire('Error', 'Something went wrong', 'error');
                            }
                        });
                    }
                });

            },
            error: function () {
                Swal.fire('Error', 'Could not load the form', 'error');
            }
        });
    }
</script>


